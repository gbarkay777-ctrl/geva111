<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#667eea">
    <meta name="background-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="×—×©×‘×•× ×™×ª Pro">
    <meta name="application-name" content="×—×©×‘×•× ×™×ª Pro">
    <meta name="msapplication-TileColor" content="#667eea">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="format-detection" content="telephone=no">
    
    <title>×—×©×‘×•× ×™×ª Pro</title>
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%23667eea' width='192' height='192' rx='40'/><text x='96' y='130' font-size='100' text-anchor='middle' fill='white'>ğŸ§¾</text></svg>">
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%23667eea' width='192' height='192' rx='40'/><text x='96' y='130' font-size='100' text-anchor='middle' fill='white'>ğŸ§¾</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%23667eea' width='192' height='192' rx='40'/><text x='96' y='130' font-size='100' text-anchor='middle' fill='white'>ğŸ§¾</text></svg>">
    <link rel="apple-touch-icon" sizes="152x152" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 152 152'><rect fill='%23667eea' width='152' height='152' rx='32'/><text x='76' y='105' font-size='80' text-anchor='middle' fill='white'>ğŸ§¾</text></svg>">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%23667eea' width='180' height='180' rx='36'/><text x='90' y='125' font-size='90' text-anchor='middle' fill='white'>ğŸ§¾</text></svg>">
    <link rel="apple-touch-icon" sizes="167x167" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 167 167'><rect fill='%23667eea' width='167' height='167' rx='33'/><text x='83' y='115' font-size='85' text-anchor='middle' fill='white'>ğŸ§¾</text></svg>">
    
    <!-- Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi15DXmdeo15QgUHJvIiwic2hvcnRfbmFtZSI6Ited15DXmdeo15QiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsInRoZW1lX2NvbG9yIjoiIzY2N2VlYSIsIm9yaWVudGF0aW9uIjoicG9ydHJhaXQiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLDxzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTkyIDE5Mic+PHJlY3QgZmlsbD0nIzY2N2VlYScgd2lkdGg9JzE5MicgaGVpZ2h0PScxOTInIHJ4PSc0MCcvPjx0ZXh0IHg9Jzk2JyB5PScxMzAnIGZvbnQtc2l6ZT0nMTAwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmaWxsPSd3aGl0ZSc+8J+PnDwvdGV4dD48L3N2Zz4iLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        html {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            height: 100%;
            color: #333;
            overflow-x: hidden;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            padding-bottom: 100px;
            padding-top: env(safe-area-inset-top);
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
        }
        
        .header {
            text-align: center;
            color: white;
            padding: 30px 0;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideUp 0.4s ease;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 0.95em;
        }
        
        input, select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            font-family: inherit;
            -webkit-appearance: none;
            appearance: none;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .payment-option {
            position: relative;
        }
        
        .payment-option input {
            position: absolute;
            opacity: 0;
        }
        
        .payment-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }
        
        .payment-option input:checked + .payment-label {
            border-color: #667eea;
            background: #eef2ff;
            color: #667eea;
            transform: scale(1.05);
        }
        
        .payment-icon {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            font-family: inherit;
            touch-action: manipulation;
            -webkit-appearance: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #555;
            margin-top: 10px;
        }
        
        .btn-danger {
            background: #fee;
            color: #c33;
            margin-top: 10px;
        }
        
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow-x: auto;
            position: sticky;
            top: 10px;
            z-index: 100;
            -webkit-overflow-scrolling: touch;
        }
        
        .nav-tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: #666;
            white-space: nowrap;
            min-width: 70px;
            user-select: none;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .invoice-preview {
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }
        
        .invoice-number {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .invoice-amount {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        
        .invoice-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            text-align: right;
        }
        
        .history-list {
            max-height: 50vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .history-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border-right: 4px solid #667eea;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .history-item:active {
            transform: scale(0.98);
            background: #eef2ff;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .history-customer {
            font-weight: 600;
            color: #333;
        }
        
        .history-amount {
            font-weight: bold;
            color: #667eea;
            font-size: 1.2em;
        }
        
        .history-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
            color: #666;
        }
        
        .payment-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-right: 5px;
        }
        
        .badge-bit { background: #e3f2fd; color: #1976d2; }
        .badge-paybox { background: #fff3e0; color: #f57c00; }
        .badge-cash { background: #e8f5e9; color: #388e3c; }
        .badge-transfer { background: #f3e5f5; color: #7b1fa2; }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 1em;
            -webkit-appearance: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
            animation: scaleIn 0.3s;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .success-icon {
            font-size: 4em;
            color: #4caf50;
            margin-bottom: 15px;
        }
        
        .customer-select {
            position: relative;
        }
        
        .add-customer-btn {
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: #667eea;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-appearance: none;
        }
        
        .hidden { display: none !important; }
        
        /* Reports Section Styles */
        .report-filters {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .big-stat {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .big-stat-value {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .big-stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            margin: 20px 0;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .summary-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        
        .summary-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .summary-label {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }
        
        .top-customers {
            margin-top: 20px;
        }
        
        .top-customer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 8px;
        }
        
        .top-customer-rank {
            width: 30px;
            height: 30px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-left: 10px;
            flex-shrink: 0;
        }
        
        .top-customer-info {
            flex: 1;
            text-align: right;
            min-width: 0;
        }
        
        .top-customer-name {
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .top-customer-count {
            font-size: 0.8em;
            color: #666;
        }
        
        .top-customer-amount {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
            white-space: nowrap;
        }
        
        .export-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Customer Section Styles */
        .customer-list {
            max-height: 50vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .customer-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .customer-item:active {
            transform: scale(0.98);
            background: #eef2ff;
        }
        
        .customer-info {
            flex: 1;
            min-width: 0;
        }
        
        .customer-name {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .customer-stats {
            font-size: 0.85em;
            color: #666;
        }
        
        .customer-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.3s;
            -webkit-appearance: none;
        }
        
        .icon-btn.view {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .icon-btn.delete {
            background: #fee;
            color: #c33;
        }
        
        .icon-btn:active {
            transform: scale(0.9);
        }
        
        .customer-detail-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .customer-detail-name {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 10px;
            word-break: break-word;
        }
        
        .customer-detail-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .customer-stat {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 10px;
        }
        
        .customer-stat-value {
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .customer-stat-label {
            font-size: 0.8em;
            opacity: 0.9;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            margin-bottom: 15px;
            font-size: 0.9em;
            -webkit-appearance: none;
        }
        
        /* Backup Section Styles */
        .backup-options {
            display: grid;
            gap: 15px;
        }
        
        .backup-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .backup-card:hover {
            border-color: #667eea;
        }
        
        .backup-title {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .backup-desc {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .file-input-label {
            display: block;
            padding: 15px;
            background: #667eea;
            color: white;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            -webkit-appearance: none;
        }
        
        .danger-zone {
            border: 2px solid #fcc;
            background: #fee;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .danger-title {
            color: #c33;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }
        
        /* Install Prompt */
        .install-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 20px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            z-index: 2000;
            display: none;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
        
        .install-banner.show {
            display: block;
            animation: slideUp 0.3s;
        }
        
        .install-title {
            font-weight: 600;
            font-size: 1.2em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .install-text {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.95em;
        }
        
        .install-buttons {
            display: flex;
            gap: 10px;
        }
        
        .install-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            -webkit-appearance: none;
        }
        
        .install-btn.primary {
            background: #667eea;
            color: white;
        }
        
        .install-btn.secondary {
            background: #f0f0f0;
            color: #666;
        }
        
        @media print {
            body { background: white; position: static; }
            .no-print { display: none !important; }
            .container { max-width: 100%; padding: 0; }
            .card { box-shadow: none; border: 1px solid #ddd; }
        }
        
        @media (display-mode: standalone) {
            .header { padding-top: 50px; }
        }
    </style>
</head>
<body>
    <!-- Install Banner -->
    <div id="install-banner" class="install-banner no-print">
        <div class="install-title">ğŸ“² ×”×ª×§×Ÿ ××ª ×”××¤×œ×™×§×¦×™×”</div>
        <div class="install-text">×”×•×¡×£ ××ª ×—×©×‘×•× ×™×ª Pro ×œ××¡×š ×”×‘×™×ª ×œ×’×™×©×” ××”×™×¨×” ×™×•×ª×¨</div>
        <div class="install-buttons">
            <button class="install-btn primary" onclick="installApp()">×”×ª×§×Ÿ ×¢×›×©×™×•</button>
            <button class="install-btn secondary" onclick="dismissInstall()">×œ× ×¢×›×©×™×•</button>
        </div>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ§¾ ×—×©×‘×•× ×™×ª Pro</h1>
            <p>× ×™×”×•×œ ×”×›× ×¡×•×ª ×•×—×©×‘×•× ×™×•×ª</p>
        </div>
        
        <div class="nav-tabs no-print">
            <div class="nav-tab active" onclick="showSection('create')">×—×“×©×”</div>
            <div class="nav-tab" onclick="showSection('customers')">×œ×§×•×—×•×ª</div>
            <div class="nav-tab" onclick="showSection('history')">×”×™×¡×˜×•×¨×™×”</div>
            <div class="nav-tab" onclick="showSection('reports')">×“×•×—×•×ª</div>
            <div class="nav-tab" onclick="showSection('backup')">×’×™×‘×•×™</div>
        </div>
        
        <!-- Create Invoice Section -->
        <div id="create-section" class="section active">
            <div class="stats no-print">
                <div class="stat-card">
                    <div class="stat-value" id="total-invoices">0</div>
                    <div class="stat-label">×—×©×‘×•× ×™×•×ª ×”×™×•×</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-amount">â‚ª0</div>
                    <div class="stat-label">×¡×”"×› ×”×™×•×</div>
                </div>
            </div>
            
            <div class="card">
                <form id="invoice-form">
                    <div class="form-group">
                        <label>×œ×§×•×—</label>
                        <div class="customer-select">
                            <select id="customer-select" onchange="handleCustomerChange()">
                                <option value="">×‘×—×¨ ×œ×§×•×— ×§×™×™×...</option>
                            </select>
                            <button type="button" class="add-customer-btn" onclick="toggleNewCustomer()">+</button>
                        </div>
                        <input type="text" id="new-customer" class="hidden" placeholder="×©× ×œ×§×•×— ×—×“×©" style="margin-top: 10px;">
                    </div>
                    
                    <div class="form-group">
                        <label>×¡×›×•× (â‚ª)</label>
                        <input type="number" id="amount" placeholder="0.00" step="0.01" required inputmode="decimal">
                    </div>
                    
                    <div class="form-group">
                        <label>×××¦×¢×™ ×ª×©×œ×•×</label>
                        <div class="payment-methods">
                            <div class="payment-option">
                                <input type="radio" name="payment" id="bit" value="×‘×™×˜" checked>
                                <label for="bit" class="payment-label">
                                    <span class="payment-icon">ğŸ’³</span>
                                    <span>×‘×™×˜</span>
                                </label>
                            </div>
                            <div class="payment-option">
                                <input type="radio" name="payment" id="paybox" value="×¤×™×™×‘×•×§×¡">
                                <label for="paybox" class="payment-label">
                                    <span class="payment-icon">ğŸ“±</span>
                                    <span>×¤×™×™×‘×•×§×¡</span>
                                </label>
                            </div>
                            <div class="payment-option">
                                <input type="radio" name="payment" id="cash" value="××–×•××Ÿ">
                                <label for="cash" class="payment-label">
                                    <span class="payment-icon">ğŸ’µ</span>
                                    <span>××–×•××Ÿ</span>
                                </label>
                            </div>
                            <div class="payment-option">
                                <input type="radio" name="payment" id="transfer" value="×”×¢×‘×¨×” ×‘× ×§××™×ª">
                                <label for="transfer" class="payment-label">
                                    <span class="payment-icon">ğŸ¦</span>
                                    <span>×”×¢×‘×¨×”</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="invoice-preview">
                        <div class="invoice-number">×—×©×‘×•× ×™×ª ××¡×¤×¨ <span id="preview-number">001</span></div>
                        <div class="invoice-amount">â‚ª<span id="preview-amount">0</span></div>
                        <div class="invoice-details">
                            <div>×œ×§×•×—: <span id="preview-customer">-</span></div>
                            <div>×ª×©×œ×•×: <span id="preview-payment">×‘×™×˜</span></div>
                            <div>×ª××¨×™×š: <span id="preview-date"></span></div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">×”×¤×§ ×—×©×‘×•× ×™×ª</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">× ×§×” ×˜×•×¤×¡</button>
                </form>
            </div>
        </div>
        
        <!-- Customers Section -->
        <div id="customers-section" class="section">
            <div class="card no-print">
                <input type="text" class="search-box" id="customer-search" placeholder="×—×¤×© ×œ×§×•×—..." oninput="filterCustomers()">
            </div>
            
            <div id="customer-list" class="customer-list"></div>
            
            <div id="customer-detail" class="hidden">
                <div class="customer-detail-header">
                    <button class="back-btn" onclick="backToCustomerList()">â† ×—×–×¨×” ×œ×¨×©×™××”</button>
                    <div class="customer-detail-name" id="detail-customer-name"></div>
                    <div class="customer-detail-stats">
                        <div class="customer-stat">
                            <div class="customer-stat-value" id="detail-total-invoices">0</div>
                            <div class="customer-stat-label">×—×©×‘×•× ×™×•×ª</div>
                        </div>
                        <div class="customer-stat">
                            <div class="customer-stat-value" id="detail-total-amount">â‚ª0</div>
                            <div class="customer-stat-label">×¡×”"×›</div>
                        </div>
                        <div class="customer-stat">
                            <div class="customer-stat-value" id="detail-last-invoice">-</div>
                            <div class="customer-stat-label">×—×©×‘×•× ×™×ª ××—×¨×•× ×”</div>
                        </div>
                    </div>
                </div>
                
                <h3 style="margin: 20px 0 15px; color: #333;">×”×™×¡×˜×•×¨×™×™×ª ×¢×¡×§××•×ª</h3>
                <div id="customer-invoices-list" class="history-list"></div>
                
                <div class="danger-zone no-print">
                    <div class="danger-title">âš ï¸ ××–×•×¨ ×¡×™×›×•×Ÿ</div>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">××—×™×§×ª ×œ×§×•×— ×ª××—×§ ××ª ×›×œ ×”×—×©×‘×•× ×™×•×ª ×©×œ×• ××”××¢×¨×›×ª. ×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×”.</p>
                    <button class="btn btn-danger" onclick="deleteCurrentCustomer()">ğŸ—‘ï¸ ××—×§ ×œ×§×•×— ×–×”</button>
                </div>
            </div>
        </div>
        
        <!-- History Section -->
        <div id="history-section" class="section">
            <div class="card no-print">
                <input type="text" class="search-box" id="search-input" placeholder="×—×™×¤×•×© ×œ×¤×™ ×œ×§×•×—, ×¡×›×•× ××• ×ª××¨×™×š..." oninput="filterHistory()">
            </div>
            
            <div id="history-list" class="history-list"></div>
            
            <button class="btn btn-secondary no-print" onclick="exportToCSV()" style="margin-top: 10px;">
                ğŸ“Š ×™×™×¦×•× ×”×›×œ ×œ-Excel
            </button>
        </div>
        
        <!-- Reports Section -->
        <div id="reports-section" class="section">
            <div class="card">
                <h3 style="margin-bottom: 15px; color: #333;">×‘×—×¨ ×ª×§×•×¤×”</h3>
                <div class="report-filters">
                    <select id="report-month" onchange="updateReports()">
                        <option value="all">×›×œ ×”×—×•×“×©×™×</option>
                        <option value="0">×™× ×•××¨</option>
                        <option value="1">×¤×‘×¨×•××¨</option>
                        <option value="2">××¨×¥</option>
                        <option value="3">××¤×¨×™×œ</option>
                        <option value="4">×××™</option>
                        <option value="5">×™×•× ×™</option>
                        <option value="6">×™×•×œ×™</option>
                        <option value="7">××•×’×•×¡×˜</option>
                        <option value="8">×¡×¤×˜××‘×¨</option>
                        <option value="9">××•×§×˜×•×‘×¨</option>
                        <option value="10">× ×•×‘××‘×¨</option>
                        <option value="11">×“×¦××‘×¨</option>
                    </select>
                    <select id="report-year" onchange="updateReports()"></select>
                </div>
                
                <div class="big-stat">
                    <div class="big-stat-label">×¡×”"×› ×”×›× ×¡×•×ª ×‘×ª×§×•×¤×”</div>
                    <div class="big-stat-value" id="report-total">â‚ª0</div>
                    <div style="font-size: 0.9em; margin-top: 10px; opacity: 0.8;">
                        <span id="report-period">×”×©× ×” ×”× ×•×›×—×™×ª</span>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
                
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-value" id="report-count">0</div>
                        <div class="summary-label">××¡×¤×¨ ×—×©×‘×•× ×™×•×ª</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="report-avg">â‚ª0</div>
                        <div class="summary-label">×××•×¦×¢ ×œ×—×©×‘×•× ×™×ª</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="report-daily">â‚ª0</div>
                        <div class="summary-label">×××•×¦×¢ ×™×•××™</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="report-max">â‚ª0</div>
                        <div class="summary-label">×—×©×‘×•× ×™×ª ××§×¡×™××œ×™×ª</div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3 style="margin-bottom: 15px; color: #333;">×œ×§×•×—×•×ª ××•×‘×™×œ×™×</h3>
                <div class="top-customers" id="top-customers"></div>
            </div>
            
            <div class="card no-print">
                <h3 style="margin-bottom: 15px; color: #333;">×™×™×¦×•× × ×ª×•× ×™×</h3>
                <div class="export-options">
                    <button class="btn btn-secondary" onclick="exportReportToCSV()">ğŸ“Š ×™×™×¦×•× ×“×•×— ×œ-Excel</button>
                    <button class="btn btn-secondary" onclick="exportYearlyReport()">ğŸ“ˆ ×“×•×— ×©× ×ª×™ ××œ×</button>
                </div>
            </div>
        </div>
        
        <!-- Backup Section -->
        <div id="backup-section" class="section">
            <div class="card">
                <h3 style="margin-bottom: 20px; color: #333;">â˜ï¸ ×’×™×‘×•×™ ×•×¡× ×›×¨×•×Ÿ</h3>
                
                <div class="backup-options">
                    <div class="backup-card">
                        <div class="backup-title">ğŸ’¾ ×™×™×¦×•× ××œ× (×’×™×‘×•×™)</div>
                        <div class="backup-desc">×©××•×¨ ××ª ×›×œ ×”× ×ª×•× ×™× - ×œ×§×•×—×•×ª, ×—×©×‘×•× ×™×•×ª ×•×”×’×“×¨×•×ª - ×›×§×•×‘×¥ ×œ×’×™×‘×•×™</div>
                        <button class="btn btn-primary" onclick="exportFullBackup()">×™×™×¦× × ×ª×•× ×™× ××œ××™×</button>
                    </div>
                    
                    <div class="backup-card">
                        <div class="backup-title">ğŸ“¥ ×™×™×‘×•× × ×ª×•× ×™×</div>
                        <div class="backup-desc">×©×—×–×¨ × ×ª×•× ×™× ××§×•×‘×¥ ×’×™×‘×•×™ ×§×™×™×</div>
                        <div class="file-input-wrapper">
                            <input type="file" id="backup-file" accept=".json" onchange="importBackup(this)">
                            <label for="backup-file" class="file-input-label">×‘×—×¨ ×§×•×‘×¥ ×’×™×‘×•×™</label>
                        </div>
                    </div>
                    
                    <div class="backup-card">
                        <div class="backup-title">ğŸ“„ ×™×™×‘×•× ×-CSV (×™×© ×—×©×‘×•× ×™×ª)</div>
                        <div class="backup-desc">×˜×¢×Ÿ × ×ª×•× ×™× ××§×•×‘×¥ CSV ×©×œ "×™×© ×—×©×‘×•× ×™×ª"</div>
                        <div class="file-input-wrapper">
                            <input type="file" id="csv-file" accept=".csv" onchange="importFromCSV(this)">
                            <label for="csv-file" class="file-input-label">×‘×—×¨ ×§×•×‘×¥ CSV</label>
                        </div>
                        <div id="csv-import-status"></div>
                    </div>
                </div>
                
                <div class="danger-zone no-print" style="margin-top: 30px;">
                    <div class="danger-title">âš ï¸ ××™×¤×•×¡ ××¢×¨×›×ª</div>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">××—×™×§×ª ×›×œ ×”× ×ª×•× ×™× ××”××¢×¨×›×ª. ×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×”!</p>
                    <button class="btn btn-danger" onclick="resetAllData()">ğŸ—‘ï¸ ××¤×¡ ××ª ×›×œ ×”× ×ª×•× ×™×</button>
                </div>
            </div>
            
            <div class="card" style="background: #e3f2fd;">
                <h4 style="color: #1976d2; margin-bottom: 10px;">ğŸ’¡ ×˜×™×¤ ×œ×’×™×‘×•×™ ××•×˜×•××˜×™</h4>
                <p style="font-size: 0.9em; color: #555;">
                    ×©××•×¨ ××ª ×§×•×‘×¥ ×”×’×™×‘×•×™ ×‘-Google Drive ××• Dropbox. ×›×š ×ª×•×›×œ ×œ×’×©×ª ×œ× ×ª×•× ×™× ××›×œ ××›×©×™×¨.
                    ××•××œ×¥ ×œ×¢×©×•×ª ×’×™×‘×•×™ ××—×ª ×œ×©×‘×•×¢.
                </p>
            </div>
        </div>
    </div>
    
    <!-- Success Modal -->
    <div id="success-modal" class="modal">
        <div class="modal-content">
            <div class="success-icon">âœ“</div>
            <h2 id="modal-title">×”×—×©×‘×•× ×™×ª ×”×•×¤×§×” ×‘×”×¦×œ×—×”!</h2>
            <p style="margin: 15px 0; color: #666;" id="modal-message"></p>
            <button class="btn btn-primary" onclick="closeModal()">××™×©×•×¨</button>
        </div>
    </div>
    
    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <div style="font-size: 3em; margin-bottom: 10px;">âš ï¸</div>
            <h2>×”×× ××ª×” ×‘×˜×•×—?</h2>
            <p style="margin: 15px 0; color: #666;" id="confirm-message"></p>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-danger" onclick="confirmAction()" style="flex: 1;">×›×Ÿ, ×”××©×š</button>
                <button class="btn btn-secondary" onclick="closeConfirmModal()" style="flex: 1;">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Data Storage
        let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
        let customers = JSON.parse(localStorage.getItem('customers')) || [];
        let currentInvoiceNumber = parseInt(localStorage.getItem('lastInvoiceNumber')) || 1;
        let revenueChart = null;
        let currentCustomer = null;
        let confirmCallback = null;
        let deferredPrompt = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateCustomerSelect();
            updatePreview();
            updateStats();
            renderHistory();
            populateYearSelect();
            renderCustomerList();
            setupInstallPrompt();
            
            document.getElementById('preview-date').textContent = new Date().toLocaleDateString('he-IL');
            
            document.getElementById('amount').addEventListener('input', updatePreview);
            document.getElementById('new-customer').addEventListener('input', updatePreview);
            document.getElementById('customer-select').addEventListener('change', updatePreview);
            
            document.querySelectorAll('input[name="payment"]').forEach(radio => {
                radio.addEventListener('change', updatePreview);
            });
            
            // Register service worker for PWA
            registerServiceWorker();
        });
        
        // Service Worker Registration - CRITICAL FOR INSTALL
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                // Create inline service worker
                const swContent = `
                    const CACHE_NAME = 'invoice-pro-v2';
                    const urlsToCache = ['/', '/index.html'];
                    
                    self.addEventListener('install', function(event) {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(function(cache) {
                                    return cache.addAll(urlsToCache);
                                })
                        );
                        self.skipWaiting();
                    });
                    
                    self.addEventListener('activate', function(event) {
                        event.waitUntil(self.clients.claim());
                    });
                    
                    self.addEventListener('fetch', function(event) {
                        event.respondWith(
                            caches.match(event.request)
                                .then(function(response) {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                })
                        );
                    });
                `;
                
                const blob = new Blob([swContent], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(function(registration) {
                        console.log('ServiceWorker registered:', registration);
                    })
                    .catch(function(error) {
                        console.log('ServiceWorker registration failed:', error);
                    });
            }
        }
        
        // Install Prompt Setup
        function setupInstallPrompt() {
            // Check if already installed
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                console.log('Already installed');
                return;
            }
            
            // Listen for beforeinstallprompt
            window.addEventListener('beforeinstallprompt', function(e) {
                console.log('beforeinstallprompt fired');
                e.preventDefault();
                deferredPrompt = e;
                
                // Show install banner after 2 seconds
                setTimeout(function() {
                    if (!localStorage.getItem('installDismissed')) {
                        document.getElementById('install-banner').classList.add('show');
                    }
                }, 2000);
            });
            
            // For iOS - show manual instructions
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (isIOS && !localStorage.getItem('installDismissed')) {
                setTimeout(function() {
                    // iOS doesn't support beforeinstallprompt, show manual banner
                    document.getElementById('install-banner').classList.add('show');
                    document.querySelector('.install-text').textContent = 
                        '×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ ×”×©×™×ª×•×£ (×”×—×¥ ×œ××¢×œ×”) ×•×‘×—×¨ "×”×•×¡×£ ×œ××¡×š ×”×‘×™×ª"';
                }, 3000);
            }
        }
        
        function installApp() {
            if (deferredPrompt) {
                // Android/Chrome
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(function(choiceResult) {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted install');
                        document.getElementById('install-banner').classList.remove('show');
                    }
                    deferredPrompt = null;
                });
            } else {
                // iOS or no prompt available
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                if (isIOS) {
                    alert('ğŸ“² ×œ×”×ª×§× ×” ×¢×œ iPhone:\n\n1. ×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ ×”×©×™×ª×•×£ (×”×—×¥ ×œ××¢×œ×”)\n2. ×’×œ×•×œ ×œ××˜×” ×•×‘×—×¨ "×”×•×¡×£ ×œ××¡×š ×”×‘×™×ª"\n3. ×œ×—×¥ ×¢×œ "×”×•×¡×£"');
                } else {
                    alert('ğŸ“² ×œ×”×ª×§× ×”:\n\nChrome: ×¤×ª×— ××ª ×”×ª×¤×¨×™×˜ (3 × ×§×•×“×•×ª) â† ×”×•×¡×£ ×œ××¡×š ×”×‘×™×ª\n\n××• ×©×ª×£ ××ª ×”×“×£ ×•×”×•×¡×£ ×œ××¡×š ×”×‘×™×ª');
                }
            }
        }
        
        function dismissInstall() {
            localStorage.setItem('installDismissed', 'true');
            document.getElementById('install-banner').classList.remove('show');
        }
        
        // Navigation
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            const sections = ['create', 'customers', 'history', 'reports', 'backup'];
            const index = sections.indexOf(section);
            
            document.getElementById(section + '-section').classList.add('active');
            document.querySelectorAll('.nav-tab')[index].classList.add('active');
            
            if (section === 'create') updateStats();
            if (section === 'customers') renderCustomerList();
            if (section === 'history') renderHistory();
            if (section === 'reports') updateReports();
            
            window.scrollTo(0, 0);
        }
        
        // Customer Management
        function updateCustomerSelect() {
            const select = document.getElementById('customer-select');
            select.innerHTML = '<option value="">×‘×—×¨ ×œ×§×•×— ×§×™×™×...</option>';
            
            customers.sort().forEach(customer => {
                const option = document.createElement('option');
                option.value = customer;
                option.textContent = customer;
                select.appendChild(option);
            });
        }
        
        function toggleNewCustomer() {
            const newCustomerInput = document.getElementById('new-customer');
            const select = document.getElementById('customer-select');
            
            if (newCustomerInput.classList.contains('hidden')) {
                newCustomerInput.classList.remove('hidden');
                select.value = '';
                newCustomerInput.focus();
            } else {
                newCustomerInput.classList.add('hidden');
                newCustomerInput.value = '';
            }
            updatePreview();
        }
        
        function handleCustomerChange() {
            const select = document.getElementById('customer-select');
            const newCustomerInput = document.getElementById('new-customer');
            
            if (select.value) {
                newCustomerInput.classList.add('hidden');
                newCustomerInput.value = '';
            }
            updatePreview();
        }
        
        // Customers Section
        function renderCustomerList(filter = '') {
            const container = document.getElementById('customer-list');
            const filteredCustomers = customers.filter(c => c.toLowerCase().includes(filter.toLowerCase()));
            
            if (filteredCustomers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‘¥</div>
                        <p>××™×Ÿ ×œ×§×•×—×•×ª ×‘×¨×©×™××”</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filteredCustomers.map(customer => {
                const customerInvoices = invoices.filter(inv => inv.customer === customer);
                const totalAmount = customerInvoices.reduce((sum, inv) => sum + inv.amount, 0);
                const count = customerInvoices.length;
                const lastInvoice = count > 0 ? customerInvoices[0].dateFormatted : '××™×Ÿ';
                
                return `
                    <div class="customer-item" onclick="viewCustomer('${customer}')">
                        <div class="customer-info">
                            <div class="customer-name">${customer}</div>
                            <div class="customer-stats">
                                ${count} ×—×©×‘×•× ×™×•×ª | ×¡×”"×›: â‚ª${totalAmount.toLocaleString()} | ××—×¨×•× ×”: ${lastInvoice}
                            </div>
                        </div>
                        <div class="customer-actions" onclick="event.stopPropagation()">
                            <button class="icon-btn view" onclick="viewCustomer('${customer}')">ğŸ‘ï¸</button>
                            <button class="icon-btn delete" onclick="deleteCustomer('${customer}')">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function filterCustomers() {
            const search = document.getElementById('customer-search').value;
            renderCustomerList(search);
        }
        
        function viewCustomer(customer) {
            currentCustomer = customer;
            const customerInvoices = invoices.filter(inv => inv.customer === customer).sort((a, b) => b.timestamp - a.timestamp);
            const totalAmount = customerInvoices.reduce((sum, inv) => sum + inv.amount, 0);
            const count = customerInvoices.length;
            const lastInvoice = count > 0 ? customerInvoices[0].dateFormatted : '-';
            
            document.getElementById('customer-list').classList.add('hidden');
            document.getElementById('customer-detail').classList.remove('hidden');
            
            document.getElementById('detail-customer-name').textContent = customer;
            document.getElementById('detail-total-invoices').textContent = count;
            document.getElementById('detail-total-amount').textContent = 'â‚ª' + totalAmount.toLocaleString();
            document.getElementById('detail-last-invoice').textContent = lastInvoice;
            
            const invoicesList = document.getElementById('customer-invoices-list');
            if (customerInvoices.length === 0) {
                invoicesList.innerHTML = '<div class="empty-state"><p>××™×Ÿ ×—×©×‘×•× ×™×•×ª ×œ×œ×§×•×— ×–×”</p></div>';
            } else {
                invoicesList.innerHTML = customerInvoices.map(inv => `
                    <div class="history-item" onclick="viewInvoice(${inv.number})">
                        <div class="history-header">
                            <span class="history-customer">×—×©×‘×•× ×™×ª #${inv.number.toString().padStart(3, '0')}</span>
                            <span class="history-amount">â‚ª${inv.amount.toLocaleString('he-IL')}</span>
                        </div>
                        <div class="history-meta">
                            <span><span class="payment-badge badge-${getPaymentClass(inv.payment)}">${inv.payment}</span></span>
                            <span>${inv.dateFormatted} | ${inv.time}</span>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function backToCustomerList() {
            document.getElementById('customer-list').classList.remove('hidden');
            document.getElementById('customer-detail').classList.add('hidden');
            currentCustomer = null;
            renderCustomerList();
        }
        
        function deleteCustomer(customer) {
            event.stopPropagation();
            const customerInvoices = invoices.filter(inv => inv.customer === customer);
            
            if (customerInvoices.length > 0) {
                showConfirm(
                    `×œ×œ×§×•×— "${customer}" ×™×© ${customerInvoices.length} ×—×©×‘×•× ×™×•×ª. ××—×™×§×ª ×”×œ×§×•×— ×ª××—×§ ×’× ××ª ×›×œ ×”×—×©×‘×•× ×™×•×ª ×©×œ×•. ×”×× ××ª×” ×‘×˜×•×—?`,
                    () => {
                        customers = customers.filter(c => c !== customer);
                        localStorage.setItem('customers', JSON.stringify(customers));
                        
                        invoices = invoices.filter(inv => inv.customer !== customer);
                        localStorage.setItem('invoices', JSON.stringify(invoices));
                        
                        showModal('×”×œ×§×•×— × ××—×§', `×”×œ×§×•×— "${customer}" ×•×›×œ ×”×—×©×‘×•× ×™×•×ª ×©×œ×• × ××—×§×• ×‘×”×¦×œ×—×”.`);
                        renderCustomerList();
                        updateCustomerSelect();
                    }
                );
            } else {
                customers = customers.filter(c => c !== customer);
                localStorage.setItem('customers', JSON.stringify(customers));
                renderCustomerList();
                updateCustomerSelect();
            }
        }
        
        function deleteCurrentCustomer() {
            if (currentCustomer) {
                deleteCustomer(currentCustomer);
                backToCustomerList();
            }
        }
        
        // Preview Updates
        function updatePreview() {
            const amount = document.getElementById('amount').value || '0';
            const select = document.getElementById('customer-select');
            const newCustomer = document.getElementById('new-customer').value;
            const payment = document.querySelector('input[name="payment"]:checked').value;
            
            document.getElementById('preview-amount').textContent = parseFloat(amount).toLocaleString('he-IL');
            document.getElementById('preview-number').textContent = currentInvoiceNumber.toString().padStart(3, '0');
            document.getElementById('preview-payment').textContent = payment;
            
            let customerName = '-';
            if (newCustomer) {
                customerName = newCustomer;
            } else if (select.value) {
                customerName = select.value;
            }
            document.getElementById('preview-customer').textContent = customerName;
        }
        
        // Form Submission
        document.getElementById('invoice-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const amount = parseFloat(document.getElementById('amount').value);
            const select = document.getElementById('customer-select');
            const newCustomer = document.getElementById('new-customer').value;
            const payment = document.querySelector('input[name="payment"]:checked').value;
            
            let customerName = newCustomer || select.value || '×œ×§×•×— ×›×œ×œ×™';
            
            if (newCustomer && !customers.includes(newCustomer)) {
                customers.push(newCustomer);
                localStorage.setItem('customers', JSON.stringify(customers));
                updateCustomerSelect();
            }
            
            const now = new Date();
            const invoice = {
                number: currentInvoiceNumber,
                customer: customerName,
                amount: amount,
                payment: payment,
                date: now.toISOString(),
                dateFormatted: now.toLocaleDateString('he-IL'),
                time: now.toLocaleTimeString('he-IL', {hour: '2-digit', minute:'2-digit'}),
                year: now.getFullYear(),
                month: now.getMonth(),
                day: now.getDate(),
                timestamp: now.getTime()
            };
            
            invoices.unshift(invoice);
            localStorage.setItem('invoices', JSON.stringify(invoices));
            
            currentInvoiceNumber++;
            localStorage.setItem('lastInvoiceNumber', currentInvoiceNumber);
            
            showModal('×”×—×©×‘×•× ×™×ª ×”×•×¤×§×” ×‘×”×¦×œ×—×”!', `××¡×¤×¨ ×—×©×‘×•× ×™×ª: ${invoice.number.toString().padStart(3, '0')}`);
            resetForm();
            updateStats();
        });
        
        function resetForm() {
            document.getElementById('invoice-form').reset();
            document.getElementById('new-customer').classList.add('hidden');
            document.getElementById('new-customer').value = '';
            document.getElementById('customer-select').value = '';
            updatePreview();
        }
        
        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('success-modal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('success-modal').classList.remove('active');
        }
        
        function showConfirm(message, callback) {
            document.getElementById('confirm-message').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirm-modal').classList.add('active');
        }
        
        function confirmAction() {
            if (confirmCallback) confirmCallback();
            closeConfirmModal();
        }
        
        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.remove('active');
            confirmCallback = null;
        }
        
        // Statistics
        function updateStats() {
            const today = new Date().toDateString();
            const todayInvoices = invoices.filter(inv => new Date(inv.date).toDateString() === today);
            
            const totalCount = todayInvoices.length;
            const totalSum = todayInvoices.reduce((sum, inv) => sum + inv.amount, 0);
            
            document.getElementById('total-invoices').textContent = totalCount;
            document.getElementById('total-amount').textContent = 'â‚ª' + totalSum.toLocaleString('he-IL');
        }
        
        // History
        function renderHistory(filtered = invoices) {
            const container = document.getElementById('history-list');
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <p>××™×Ÿ ×—×©×‘×•× ×™×•×ª ×‘×”×™×¡×˜×•×¨×™×”</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(inv => `
                <div class="history-item" onclick="viewInvoice(${inv.number})">
                    <div class="history-header">
                        <span class="history-customer">${inv.customer}</span>
                        <span class="history-amount">â‚ª${inv.amount.toLocaleString('he-IL')}</span>
                    </div>
                    <div class="history-meta">
                        <span>
                            <span class="payment-badge badge-${getPaymentClass(inv.payment)}">${inv.payment}</span>
                            #${inv.number.toString().padStart(3, '0')}
                        </span>
                        <span>${inv.dateFormatted} | ${inv.time}</span>
                    </div>
                </div>
            `).join('');
        }
        
        function getPaymentClass(payment) {
            const map = {
                '×‘×™×˜': 'bit',
                '×¤×™×™×‘×•×§×¡': 'paybox',
                '××–×•××Ÿ': 'cash',
                '×”×¢×‘×¨×” ×‘× ×§××™×ª': 'transfer'
            };
            return map[payment] || 'bit';
        }
        
        function filterHistory() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const filtered = invoices.filter(inv => 
                inv.customer.toLowerCase().includes(search) ||
                inv.amount.toString().includes(search) ||
                inv.dateFormatted.includes(search) ||
                inv.number.toString().includes(search)
            );
            renderHistory(filtered);
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×¤×ª×™×—×ª ×—×©×‘×•× ×™×ª ×‘×—×œ×•×Ÿ ×—×“×© ×¢× ×ª×¦×•×’×” ××•×ª×××ª ×œ×˜×œ×¤×•×Ÿ
        function viewInvoice(number) {
            const invoice = invoices.find(inv => inv.number === number);
            if (!invoice) return;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html dir="rtl">
                <head>
                    <title>×—×©×‘×•× ×™×ª #${invoice.number}</title>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        html, body {
                            width: 100%;
                            height: 100%;
                            overflow-x: hidden;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                        }
                        
                        body { 
                            background: #f5f5f5; 
                            padding: 10px;
                            direction: rtl;
                        }
                        
                        .invoice-container {
                            max-width: 100%;
                            width: 100%;
                            margin: 0 auto;
                            background: white;
                            border-radius: 12px;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                            overflow: hidden;
                        }
                        
                        .invoice-header { 
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 30px 20px;
                            text-align: center;
                        }
                        
                        .invoice-title { 
                            font-size: 1.8em; 
                            margin-bottom: 10px;
                            font-weight: bold;
                        }
                        
                        .invoice-number {
                            font-size: 1.1em;
                            opacity: 0.9;
                        }
                        
                        .invoice-body {
                            padding: 25px 20px;
                        }
                        
                        .detail-row { 
                            display: flex; 
                            justify-content: space-between; 
                            align-items: center;
                            padding: 18px 0; 
                            border-bottom: 1px solid #eee;
                            font-size: 1.1em;
                        }
                        
                        .detail-row:last-child {
                            border-bottom: none;
                        }
                        
                        .label { 
                            font-weight: 600; 
                            color: #666;
                            font-size: 0.95em;
                        }
                        
                        .value { 
                            font-size: 1.1em;
                            color: #333;
                            font-weight: 500;
                            text-align: left;
                        }
                        
                        .amount-container {
                            background: #f8f9fa;
                            border-radius: 12px;
                            padding: 25px;
                            margin: 25px 0;
                            text-align: center;
                        }
                        
                        .amount-label {
                            color: #666;
                            font-size: 1em;
                            margin-bottom: 10px;
                        }
                        
                        .amount { 
                            font-size: 3em; 
                            color: #667eea; 
                            font-weight: bold;
                            direction: ltr;
                            display: inline-block;
                        }
                        
                        .footer { 
                            margin-top: 30px;
                            padding: 20px;
                            text-align: center; 
                            color: #999; 
                            font-size: 0.9em;
                            background: #f8f9fa;
                            border-top: 1px solid #eee;
                        }
                        
                        .actions {
                            position: fixed;
                            bottom: 0;
                            left: 0;
                            right: 0;
                            background: white;
                            padding: 15px;
                            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
                            display: flex;
                            gap: 10px;
                            justify-content: center;
                            flex-wrap: wrap;
                            z-index: 1000;
                        }
                        
                        .btn {
                            padding: 15px 25px;
                            border: none;
                            border-radius: 10px;
                            font-size: 1em;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s;
                            flex: 1;
                            min-width: 120px;
                            max-width: 200px;
                        }
                        
                        .btn-primary {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                        }
                        
                        .btn-danger {
                            background: #fee;
                            color: #c33;
                        }
                        
                        .btn-secondary {
                            background: #f0f0f0;
                            color: #555;
                        }
                        
                        .btn:active {
                            transform: scale(0.98);
                        }
                        
                        .content-wrapper {
                            padding-bottom: 100px;
                        }
                        
                        @media print { 
                            body { 
                                background: white;
                                padding: 0;
                            }
                            .actions { 
                                display: none !important; 
                            }
                            .invoice-container {
                                box-shadow: none;
                                border-radius: 0;
                            }
                            .content-wrapper {
                                padding-bottom: 0;
                            }
                            .footer {
                                background: white;
                            }
                        }
                        
                        @media (max-width: 480px) {
                            .invoice-title {
                                font-size: 1.5em;
                            }
                            .amount {
                                font-size: 2.5em;
                            }
                            .detail-row {
                                font-size: 1em;
                                padding: 15px 0;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="content-wrapper">
                        <div class="invoice-container">
                            <div class="invoice-header">
                                <div class="invoice-title">ğŸ§¾ ×—×©×‘×•× ×™×ª ××¡</div>
                                <div class="invoice-number">××¡×¤×¨ ${invoice.number.toString().padStart(3, '0')}</div>
                            </div>
                            
                            <div class="invoice-body">
                                <div class="detail-row">
                                    <span class="label">×ª××¨×™×š:</span>
                                    <span class="value">${invoice.dateFormatted}</span>
                                </div>
                                
                                <div class="detail-row">
                                    <span class="label">×©×¢×”:</span>
                                    <span class="value">${invoice.time}</span>
                                </div>
                                
                                <div class="detail-row">
                                    <span class="label">×œ×§×•×—:</span>
                                    <span class="value">${invoice.customer}</span>
                                </div>
                                
                                <div class="detail-row">
                                    <span class="label">×××¦×¢×™ ×ª×©×œ×•×:</span>
                                    <span class="value">${invoice.payment}</span>
                                </div>
                                
                                <div class="amount-container">
                                    <div class="amount-label">×¡×›×•× ×œ×ª×©×œ×•×</div>
                                    <div class="amount">â‚ª${invoice.amount.toLocaleString('he-IL')}</div>
                                </div>
                            </div>
                            
                            <div class="footer">
                                <p style="margin-bottom: 5px; font-weight: 600; color: #667eea;">×ª×•×“×” ×¢×œ ×”×¢×¡×§×”!</p>
                                <p>×©××•×¨ ×¢×œ ×”×—×©×‘×•× ×™×ª ×œ×¦×¨×›×™ ××¡</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="actions">
                        <button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸ ×”×“×¤×¡ / ×©××•×¨ PDF</button>
                        <button class="btn btn-danger" onclick="deleteInvoice(${invoice.number})">ğŸ—‘ï¸ ××—×§ ×§×‘×œ×”</button>
                        <button class="btn btn-secondary" onclick="window.close()">âŒ ×¡×’×•×¨</button>
                    </div>
                    
                    <script>
                        function deleteInvoice(number) {
                            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×§×‘×œ×” ××¡×¤×¨ ' + number + '?\\n×¤×¢×•×œ×” ×–×• ×‘×œ×ª×™ ×”×¤×™×›×”!')) {
                                // ×©×•×œ×— ×”×•×“×¢×” ×œ×—×œ×•×Ÿ ×”××‘ ×œ××—×™×§×ª ×”×§×‘×œ×”
                                if (window.opener && window.opener.deleteInvoiceFromWindow) {
                                    window.opener.deleteInvoiceFromWindow(number);
                                    window.close();
                                } else {
                                    alert('×œ× × ×™×ª×Ÿ ×œ××—×•×§ - ×—×œ×•×Ÿ ×”××‘ ×¡×’×•×¨. × ×¡×” ×œ×¡×’×•×¨ ×•×œ×¤×ª×•×— ××—×“×©.');
                                }
                            }
                        }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        // ×¤×•× ×§×¦×™×” ×œ××—×™×§×ª ×§×‘×œ×” ××—×œ×•×Ÿ ×¦×¤×™×™×”
        function deleteInvoiceFromWindow(number) {
            showConfirm(
                `×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×§×‘×œ×” ××¡×¤×¨ ${number.toString().padStart(3, '0')}?`,
                () => {
                    // ××—×™×§×ª ×”×§×‘×œ×” ××”××¢×¨×›×ª
                    invoices = invoices.filter(inv => inv.number !== number);
                    localStorage.setItem('invoices', JSON.stringify(invoices));
                    
                    // ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
                    renderHistory();
                    updateStats();
                    renderCustomerList();
                    if (currentCustomer) {
                        viewCustomer(currentCustomer);
                    }
                    
                    showModal('×”×§×‘×œ×” × ××—×§×”', `×§×‘×œ×” ××¡×¤×¨ ${number.toString().padStart(3, '0')} × ××—×§×” ×‘×”×¦×œ×—×”.`);
                }
            );
        }
        
        // Reports Functions
        function populateYearSelect() {
            const yearSelect = document.getElementById('report-year');
            const currentYear = new Date().getFullYear();
            const years = [...new Set(invoices.map(inv => inv.year))].sort((a, b) => b - a);
            
            if (years.length === 0) years.push(currentYear);
            
            yearSelect.innerHTML = years.map(year => 
                `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year}</option>`
            ).join('');
        }
        
        function updateReports() {
            const month = document.getElementById('report-month').value;
            const year = parseInt(document.getElementById('report-year').value);
            
            let filtered = invoices.filter(inv => inv.year === year);
            if (month !== 'all') {
                filtered = filtered.filter(inv => inv.month === parseInt(month));
            }
            
            const total = filtered.reduce((sum, inv) => sum + inv.amount, 0);
            const count = filtered.length;
            const avg = count > 0 ? total / count : 0;
            const max = count > 0 ? Math.max(...filtered.map(inv => inv.amount)) : 0;
            
            let dailyAvg = 0;
            if (count > 0) {
                if (month !== 'all') {
                    const daysInMonth = new Date(year, parseInt(month) + 1, 0).getDate();
                    dailyAvg = total / daysInMonth;
                } else {
                    const isCurrentYear = year === new Date().getFullYear();
                    const startOfYear = new Date(year, 0, 1);
                    const now = isCurrentYear ? new Date() : new Date(year, 11, 31);
                    const daysCount = Math.max(1, Math.floor((now - startOfYear) / (1000 * 60 * 60 * 24)));
                    dailyAvg = total / daysCount;
                }
            }
            
            document.getElementById('report-total').textContent = 'â‚ª' + total.toLocaleString('he-IL', {maximumFractionDigits: 0});
            document.getElementById('report-count').textContent = count;
            document.getElementById('report-avg').textContent = 'â‚ª' + Math.round(avg).toLocaleString('he-IL');
            document.getElementById('report-daily').textContent = 'â‚ª' + Math.round(dailyAvg).toLocaleString('he-IL');
            document.getElementById('report-max').textContent = 'â‚ª' + max.toLocaleString('he-IL');
            
            const monthNames = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
            const periodText = month === 'all' ? `×©× ×ª ${year}` : `${monthNames[parseInt(month)]} ${year}`;
            document.getElementById('report-period').textContent = periodText;
            
            updateChart(filtered, month, year);
            updateTopCustomers(filtered);
        }
        
        function updateChart(filteredInvoices, month, year) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            if (revenueChart) {
                revenueChart.destroy();
            }
            
            let labels, data;
            
            if (month !== 'all') {
                const daysInMonth = new Date(year, parseInt(month) + 1, 0).getDate();
                labels = Array.from({length: daysInMonth}, (_, i) => (i + 1).toString());
                data = new Array(daysInMonth).fill(0);
                
                filteredInvoices.forEach(inv => {
                    if (inv.day <= daysInMonth) {
                        data[inv.day - 1] += inv.amount;
                    }
                });
            } else {
                labels = ['×™× ×•', '×¤×‘×¨', '××¨×¥', '××¤×¨', '×××™', '×™×•× ', '×™×•×œ', '××•×’', '×¡×¤×˜', '××•×§', '× ×•×‘', '×“×¦×'];
                data = new Array(12).fill(0);
                
                filteredInvoices.forEach(inv => {
                    data[inv.month] += inv.amount;
                });
            }
            
            revenueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '×”×›× ×¡×•×ª (â‚ª)',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'â‚ª' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateTopCustomers(filteredInvoices) {
            const customerStats = {};
            
            filteredInvoices.forEach(inv => {
                if (!customerStats[inv.customer]) {
                    customerStats[inv.customer] = { amount: 0, count: 0 };
                }
                customerStats[inv.customer].amount += inv.amount;
                customerStats[inv.customer].count += 1;
            });
            
            const sorted = Object.entries(customerStats)
                .sort((a, b) => b[1].amount - a[1].amount)
                .slice(0, 5);
            
            const container = document.getElementById('top-customers');
            
            if (sorted.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 20px;"><p>××™×Ÿ × ×ª×•× ×™× ×œ×ª×§×•×¤×” ×–×•</p></div>';
                return;
            }
            
            container.innerHTML = sorted.map((item, index) => `
                <div class="top-customer-item" onclick="viewCustomer('${item[0]}')" style="cursor: pointer;">
                    <div class="top-customer-rank">${index + 1}</div>
                    <div class="top-customer-info">
                        <div class="top-customer-name">${item[0]}</div>
                        <div class="top-customer-count">${item[1].count} ×—×©×‘×•× ×™×•×ª</div>
                    </div>
                    <div class="top-customer-amount">â‚ª${item[1].amount.toLocaleString()}</div>
                </div>
            `).join('');
        }
        
        // Backup Functions
        function exportFullBackup() {
            const backup = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                customers: customers,
                invoices: invoices,
                lastInvoiceNumber: currentInvoiceNumber
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const blob = new Blob(['\ufeff' + dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `×—×©×‘×•× ×™×ª_Pro_×’×™×‘×•×™_${new Date().toLocaleDateString('he-IL')}.json`;
            link.click();
            
            showModal('×’×™×‘×•×™ ×”×•×©×œ×', '×§×•×‘×¥ ×”×’×™×‘×•×™ × ×©××¨ ×‘×”×¦×œ×—×”. ×©××•×¨ ××•×ª×• ×‘××§×•× ×‘×˜×•×—.');
        }
        
        function importBackup(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (!backup.customers || !backup.invoices) {
                        throw new Error('×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ');
                    }
                    
                    showConfirm(
                        `×”×× ×œ×©×—×–×¨ ××ª ×”×’×™×‘×•×™?\n×”×“×‘×¨ ×™×—×œ×™×£ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×§×™×™××™× (${customers.length} ×œ×§×•×—×•×ª, ${invoices.length} ×—×©×‘×•× ×™×•×ª) ×‘× ×ª×•× ×™ ×”×’×™×‘×•×™ (${backup.customers.length} ×œ×§×•×—×•×ª, ${backup.invoices.length} ×—×©×‘×•× ×™×•×ª).`,
                        () => {
                            customers = backup.customers;
                            invoices = backup.invoices;
                            currentInvoiceNumber = backup.lastInvoiceNumber || 1;
                            
                            localStorage.setItem('customers', JSON.stringify(customers));
                            localStorage.setItem('invoices', JSON.stringify(invoices));
                            localStorage.setItem('lastInvoiceNumber', currentInvoiceNumber);
                            
                            updateCustomerSelect();
                            renderCustomerList();
                            updateStats();
                            
                            showModal('×©×—×–×•×¨ ×”×•×©×œ×', `× ×©××¨×• ${customers.length} ×œ×§×•×—×•×ª ×•-${invoices.length} ×—×©×‘×•× ×™×•×ª.`);
                        }
                    );
                } catch (err) {
                    showModal('×©×’×™××”', '×§×•×‘×¥ ×”×’×™×‘×•×™ ×¤×’×•× ××• ×œ× ×ª×§×™×Ÿ.');
                }
            };
            reader.readAsText(file);
            input.value = '';
        }
        
        function resetAllData() {
            showConfirm(
                '×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™×?\n×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”×œ×§×•×—×•×ª ×•×”×—×©×‘×•× ×™×•×ª ×œ×¦××™×ª×•×ª!',
                () => {
                    customers = [];
                    invoices = [];
                    currentInvoiceNumber = 1;
                    
                    localStorage.removeItem('customers');
                    localStorage.removeItem('invoices');
                    localStorage.removeItem('lastInvoiceNumber');
                    
                    updateCustomerSelect();
                    renderCustomerList();
                    renderHistory();
                    updateStats();
                    
                    showModal('×”××¢×¨×›×ª ××•×¤×¡×”', '×›×œ ×”× ×ª×•× ×™× × ××—×§×• ×‘×”×¦×œ×—×”.');
                }
            );
        }
        
        // CSV Import from "Yesh Invoice"
        function importFromCSV(input) {
            const file = input.files[0];
            if (!file) return;
            
            const statusDiv = document.getElementById('csv-import-status');
            statusDiv.innerHTML = '<div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div><p style="text-align: center; margin-top: 10px;">×˜×•×¢×Ÿ × ×ª×•× ×™×...</p>';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        throw new Error('×§×•×‘×¥ ×¨×™×§ ××• ×œ× ×ª×§×™×Ÿ');
                    }
                    
                    const newInvoices = [];
                    const newCustomers = new Set(customers);
                    let maxNum = currentInvoiceNumber;
                    let importedCount = 0;
                    let skippedCount = 0;
                    
                    // Skip header line (line 0)
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        // Parse CSV line properly
                        const parts = parseCSVLine(line);
                        
                        // Check if we have enough columns
                        if (parts.length < 14) {
                            console.warn('×©×•×¨×” ×œ× ×ª×§×™× ×” (×œ× ××¡×¤×™×§ ×¢××•×“×•×ª):', line);
                            skippedCount++;
                            continue;
                        }
                        
                        // Extract data according to CSV structure:
                        // 0: ×¡×˜×˜×•×¡, 1: ××¡', 2: ×¡×•×’ ××¡××š, 3: ×©× ×œ×§×•×—/×¡×¤×§, 
                        // 4: ×ª×¢×•×“×ª ×–×”×•×ª, 5: ×˜×œ×¤×•×Ÿ, 6: × ×™×™×“, 7: ×›×ª×•×‘×ª, 8: ×™×™×©×•×‘, 9: ×ª×™××•×¨,
                        // 10: ×××¦×¢×™ ×ª×©×œ×•×, 11: ×ª××¨×™×š, 12: ×¢×“ ×ª××¨×™×š, 13: ×¡×›×•×
                        
                        const invoiceNum = parseInt(parts[1]);
                        const customerName = parts[3].trim();
                        const dateStr = parts[11].trim();
                        const amountStr = parts[13].trim();
                        
                        // Validate data
                        if (!customerName || isNaN(invoiceNum)) {
                            console.warn('×©×•×¨×” ×œ× ×ª×§×™× ×” (× ×ª×•× ×™× ×—×¡×¨×™×):', line);
                            skippedCount++;
                            continue;
                        }
                        
                        // Parse amount - remove any non-numeric chars except dot
                        const amount = parseFloat(amountStr.replace(/[^\d.]/g, ''));
                        if (isNaN(amount) || amount <= 0) {
                            console.warn('×©×•×¨×” ×œ× ×ª×§×™× ×” (×¡×›×•× ×œ× ×ª×§×™×Ÿ):', amountStr);
                            skippedCount++;
                            continue;
                        }
                        
                        // Parse date (format: DD-MM-YYYY)
                        const dateParts = dateStr.split('-');
                        if (dateParts.length !== 3) {
                            console.warn('×©×•×¨×” ×œ× ×ª×§×™× ×” (×ª××¨×™×š ×œ× ×ª×§×™×Ÿ):', dateStr);
                            skippedCount++;
                            continue;
                        }
                        
                        const day = parseInt(dateParts[0], 10);
                        const month = parseInt(dateParts[1], 10) - 1; // JS months are 0-based
                        const year = parseInt(dateParts[2], 10);
                        
                        // Validate date
                        if (isNaN(day) || isNaN(month) || isNaN(year) || month < 0 || month > 11) {
                            console.warn('×©×•×¨×” ×œ× ×ª×§×™× ×” (×ª××¨×™×š ×œ× ×ª×§×™×Ÿ):', dateStr);
                            skippedCount++;
                            continue;
                        }
                        
                        const date = new Date(year, month, day);
                        
                        // Create invoice object
                        const invoice = {
                            number: invoiceNum,
                            customer: customerName,
                            amount: amount,
                            payment: '×”×¢×‘×¨×” ×‘× ×§××™×ª', // Default for imported from YeshInvoice
                            date: date.toISOString(),
                            dateFormatted: date.toLocaleDateString('he-IL'),
                            time: '12:00',
                            year: year,
                            month: month,
                            day: day,
                            timestamp: date.getTime(),
                            imported: true,
                            source: 'yeshinvoice'
                        };
                        
                        newInvoices.push(invoice);
                        newCustomers.add(customerName);
                        
                        if (invoiceNum >= maxNum) {
                            maxNum = invoiceNum + 1;
                        }
                        
                        importedCount++;
                        
                        // Update progress
                        const progress = Math.round((i / lines.length) * 100);
                        const progressBar = statusDiv.querySelector('.progress-fill');
                        if (progressBar) {
                            progressBar.style.width = progress + '%';
                        }
                    }
                    
                    if (newInvoices.length === 0) {
                        statusDiv.innerHTML = '<p style="color: #c33; text-align: center; margin-top: 10px;">×œ× × ××¦××• ×—×©×‘×•× ×™×•×ª ×ª×§×™× ×•×ª ×‘×§×•×‘×¥</p>';
                        showModal('×©×’×™××”', '×œ× × ×™×ª×Ÿ ×œ×™×™×‘× × ×ª×•× ×™× ××”×§×•×‘×¥. ×•×“× ×©×”×§×•×‘×¥ ×‘×ª×‘× ×™×ª ×”× ×›×•× ×”.');
                        return;
                    }
                    
                    showConfirm(
                        `× ××¦××• ${newInvoices.length} ×—×©×‘×•× ×™×•×ª ×ª×§×™× ×•×ª (${skippedCount} ×“×•×œ×’×•) ×•-${newCustomers.size - customers.size} ×œ×§×•×—×•×ª ×—×“×©×™×.\n×”×× ×œ×™×™×‘× ××•×ª× ×œ××¢×¨×›×ª?`,
                        () => {
                            // Merge data - avoid duplicates by invoice number
                            const existingNumbers = new Set(invoices.map(inv => inv.number));
                            const uniqueNewInvoices = newInvoices.filter(inv => !existingNumbers.has(inv.number));
                            
                            // Add all invoices (including duplicates if user wants, but we filter)
                            invoices = [...invoices, ...uniqueNewInvoices].sort((a, b) => b.timestamp - a.timestamp);
                            customers = Array.from(newCustomers);
                            currentInvoiceNumber = maxNum;
                            
                            localStorage.setItem('invoices', JSON.stringify(invoices));
                            localStorage.setItem('customers', JSON.stringify(customers));
                            localStorage.setItem('lastInvoiceNumber', currentInvoiceNumber);
                            
                            updateCustomerSelect();
                            renderCustomerList();
                            updateStats();
                            populateYearSelect();
                            
                            statusDiv.innerHTML = `<p style="color: #4caf50; text-align: center; margin-top: 10px;">âœ“ ×”×™×™×‘×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”! ×™×•×‘××• ${uniqueNewInvoices.length} ×—×©×‘×•× ×™×•×ª ×—×“×©×•×ª.</p>`;
                            showModal('×™×™×‘×•× ×”×•×©×œ×', `×™×•×‘××• ${uniqueNewInvoices.length} ×—×©×‘×•× ×™×•×ª ×—×“×©×•×ª ×•-${customers.length} ×œ×§×•×—×•×ª ×¡×”"×›.`);
                        }
                    );
                    
                } catch (err) {
                    console.error('×©×’×™××” ×‘×™×™×‘×•×:', err);
                    statusDiv.innerHTML = '<p style="color: #c33; text-align: center; margin-top: 10px;">×©×’×™××” ×‘×™×™×‘×•× ×”×§×•×‘×¥</p>';
                    showModal('×©×’×™××”', '×œ× × ×™×ª×Ÿ ×œ×§×¨×•× ××ª ×§×•×‘×¥ ×”-CSV. ×•×“× ×©×”×§×•×‘×¥ ×‘×ª×‘× ×™×ª ×”× ×›×•× ×”.');
                }
            };
            
            reader.onerror = function() {
                statusDiv.innerHTML = '<p style="color: #c33; text-align: center; margin-top: 10px;">×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥</p>';
                showModal('×©×’×™××”', '×œ× × ×™×ª×Ÿ ×œ×§×¨×•× ××ª ×”×§×•×‘×¥.');
            };
            
            reader.readAsText(file, 'UTF-8');
            input.value = '';
        }
        
        // Improved CSV line parser that handles quoted fields properly
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Escaped quote ("") inside quoted field
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quote state
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // End of field
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // Don't forget the last field
            result.push(current.trim());
            
            return result;
        }
        
        // Export Functions
        function exportToCSV() {
            if (invoices.length === 0) {
                alert('××™×Ÿ ×—×©×‘×•× ×™×•×ª ×œ×™×™×¦×•×');
                return;
            }
            
            const csv = [
                ['××¡×¤×¨', '×ª××¨×™×š', '×œ×§×•×—', '×¡×›×•×', '×××¦×¢×™ ×ª×©×œ×•×', '×©× ×”', '×—×•×“×©'].join(','),
                ...invoices.map(inv => [
                    inv.number,
                    inv.dateFormatted,
                    `"${inv.customer}"`,
                    inv.amount,
                    inv.payment,
                    inv.year,
                    inv.month + 1
                ].join(','))
            ].join('\n');
            
            downloadCSV(csv, `×—×©×‘×•× ×™×•×ª_${new Date().toLocaleDateString('he-IL')}.csv`);
        }
        
        function exportReportToCSV() {
            const month = document.getElementById('report-month').value;
            const year = parseInt(document.getElementById('report-year').value);
            
            let filtered = invoices.filter(inv => inv.year === year);
            if (month !== 'all') {
                filtered = filtered.filter(inv => inv.month === parseInt(month));
            }
            
            if (filtered.length === 0) {
                alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•× ×‘×ª×§×•×¤×” ×–×•');
                return;
            }
            
            const csv = [
                ['××¡×¤×¨', '×ª××¨×™×š', '×œ×§×•×—', '×¡×›×•×', '×××¦×¢×™ ×ª×©×œ×•×'].join(','),
                ...filtered.map(inv => [
                    inv.number,
                    inv.dateFormatted,
                    `"${inv.customer}"`,
                    inv.amount,
                    inv.payment
                ].join(','))
            ].join('\n');
            
            const monthNames = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
            const period = month === 'all' ? year : `${monthNames[parseInt(month)]}_${year}`;
            
            downloadCSV(csv, `×“×•×—_×”×›× ×¡×•×ª_${period}.csv`);
        }
        
        function exportYearlyReport() {
            const year = parseInt(document.getElementById('report-year').value);
            const yearInvoices = invoices.filter(inv => inv.year === year);
            
            if (yearInvoices.length === 0) {
                alert('××™×Ÿ × ×ª×•× ×™× ×œ×©× ×” ×–×•');
                return;
            }
            
            const monthlyData = {};
            for (let i = 0; i < 12; i++) {
                monthlyData[i] = { count: 0, amount: 0 };
            }
            
            yearInvoices.forEach(inv => {
                monthlyData[inv.month].count += 1;
                monthlyData[inv.month].amount += inv.amount;
            });
            
            const monthNames = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
            
            let csv = '×“×•×— ×©× ×ª×™,' + year + '\n\n';
            csv += '×—×•×“×©,××¡×¤×¨ ×—×©×‘×•× ×™×•×ª,×¡×”"×› ×”×›× ×¡×•×ª,×××•×¦×¢ ×œ×—×©×‘×•× ×™×ª\n';
            
            for (let i = 0; i < 12; i++) {
                const avg = monthlyData[i].count > 0 ? monthlyData[i].amount / monthlyData[i].count : 0;
                csv += `${monthNames[i]},${monthlyData[i].count},${monthlyData[i].amount},${avg.toFixed(2)}\n`;
            }
            
            const totalAmount = yearInvoices.reduce((sum, inv) => sum + inv.amount, 0);
            const totalCount = yearInvoices.length;
            const totalAvg = totalCount > 0 ? totalAmount / totalCount : 0;
            
            csv += `\n×¡×”"×›,${totalCount},${totalAmount},${totalAvg.toFixed(2)}\n`;
            
            downloadCSV(csv, `×“×•×—_×©× ×ª×™_${year}.csv`);
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }
    </script>
</body>
</html>